/*
 2099 Sweep Composer
 https://tr2099.github.io/
 See LICENSE for copyright information.
*/
var TR2099=function(){this._samples=[];this._bitDepth=this._sampleRate=this._amplitude=0;this._sumSamples=!1;this._waveform={noise:noise,square:square,sawtooth:sawtooth,sine:sine,triangle:triangle}};
TR2099.prototype.sequenceToDataURI=function(a,b,d,f,c,e,g,h){this._sumSamples=f;this._sampleRate=d;this._bitDepth=b;this._attack=c;this._release=e;this._setAmplitude(h.decimate);d=this._getSamples(a);h.rectify&&rectifier(d,h.rectify);f?this._sum(d):this._sequence(d);h.lpf&&lowPassFilter(this._samples,h.lpf,this._sampleRate,1);h.dither&&dithering(this._samples,h.dither);this._gain();h.decimate&&this._fixDecimated(a.length);"4"!==b&&("8"===b?this._fix8BitRange():"32f"==b?this._fix32IEEERange():"64"==
b&&this._fix64BitRange());a=1;g&&(this._samples=interleave([this._samples,this._samples]),a=2);return writeWavDataURI(a,this._sampleRate,this._bitDepth,this._samples)};TR2099.prototype._fix8BitRange=function(){for(var a=0;a<this._samples.length;a++)this._samples[a]+=127};TR2099.prototype._fix32IEEERange=function(){for(var a=0;a<this._samples.length;a++)this._samples[a]/=2147483648};TR2099.prototype._fix64BitRange=function(){for(var a=0;a<this._samples.length;a++)this._samples[a]/=0x7fffffffffffffff};
TR2099.prototype._setAmplitude=function(a){a=a?parseInt(a):parseInt(this._bitDepth);this._amplitude=.7*BitDepths[a]};TR2099.prototype._fixDecimated=function(a){var b;for(b=0;b<this._samples.length;b++)this._samples[b]=0<this._samples[b]?parseInt(this._samples[b])/this._amplitude:parseInt(this._samples[b])/(this._amplitude+1);this._amplitude=.7*BitDepths[parseInt(this._bitDepth)];this._sumSamples&&(this._amplitude/=a);this._gain()};
TR2099.prototype._getSamples=function(a){var b=0,d=0,f=[],c,e;for(c=0;c<a.length;c++){f[c]={samples:[],waveform:a[c].waveform,time:a[c].time};var g=Math.round(this._sampleRate*a[c].time);var h=g/this._sampleRate;for(e=0;e<g;e++){var k=e/g;k=this._waveform[a[c].waveform](h*k,k,d,a[c],b);f[c].samples.push(k)}d=2*Math.PI*h*(a[c].start+(a[c].end-a[c].start)/2);b+=d}return f};
TR2099.prototype._sequence=function(a){var b=[],d,f;for(d=0;d<a.length;d++)for(f=0;f<a[d].samples.length;f++)b.push(a[d].samples[f]);this._samples=b};
TR2099.prototype._sum=function(a){var b=0,d=0,f=!1,c=[],e;this._amplitude/=a.length;for(e=0;e<a.length;e++)a[e].time*this._sampleRate>b&&(b=a[e].time*this._sampleRate,d=e,0<e&&(f=!0));for(e=0;e<b;e++)c[e]=0;for(e=0;e<a.length;e++)for(b=0;b<a[e].samples.length;b++)f&&b>a[e].samples.length/1.1&&this._releaseOnSum(a,this._sampleRate,b,e,d),c[b]=parseFloat(a[e].samples[b])+parseFloat(c[b]);this._samples=c};
TR2099.prototype._releaseOnSum=function(a,b,d,f){var c=a[d].samples.length/this._sampleRate,e=.1*c,g=Math.round(this._sampleRate*c);c=g/this._sampleRate;g=b/g*c;d!=f&&(a[d].samples[b]/=e/(c-g)*e/(c-g))};TR2099.prototype._gain=function(){var a;for(a=0;a<this._samples.length;a++){var b=this._attackDecay(a);this._samples[a]=0<this._samples[a]?this._samples[a]*b:this._samples[a]*(b+1)}};
TR2099.prototype._attackDecay=function(a){var b=this._samples.length/this._sampleRate,d=(100-this._attack)/100*b,f=this._release/100*(b-d),c=Math.round(this._sampleRate*b);b=c/this._sampleRate;a=a/c*b;return a>d?a<b-f?this._amplitude:this._amplitude/(f/(b-a)*f/(b-a)):d?this._amplitude/(d/a*d/a):this._amplitude};