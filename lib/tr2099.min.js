/*
 2099 Sweep Composer
 https://tr2099.github.io/
 See LICENSE for copyright information.

*/
function interleave(a){var b=[],d,e,c=a[0].length;for(d=0;d<c;d++)for(e=0;e<a.length;e++)b.push(a[e][d]);return b}function deInterleave(a,b){var d=[],e;for(e=0;e<b;e++)d[e]=[];e=0;for(var c;e<a.length;){for(c=0;c<b;c++)d[c].push(a[e+c]);e+=c}return d}var TR2099=function(){this._samples=[];this._bitDepth=this._sampleRate=this._amplitude=0;this._sumSamples=!1;this._waveform={noise:noise,square:square,sawtooth:sawtooth,sine:sine,triangle:triangle}};
TR2099.prototype.sequenceToDataURI=function(a,b,d,e,c,f,g,h){this._sumSamples=e;this._sampleRate=d;this._bitDepth=b;this._attack=c;this._release=f;this._setAmplitude(h.decimate);d=this._getSamples(a);h.rectify&&rectifier(d,h.rectify);e?this._sum(d):this._sequence(d);h.lpf&&lowPassFilter(this._samples,h.lpf,this._sampleRate,1);h.dither&&dithering(this._samples,h.dither);this._gain();h.decimate&&this._fixDecimated(a.length);"4"!==b&&("8"===b?this._fix8BitRange():"32f"==b?this._fix32IEEERange():"64"==
b&&this._fix64BitRange());a=1;g&&(this._samples=interleave([this._samples,this._samples]),a=2);g=new WaveFile;g.fromScratch(a,this._sampleRate,this._bitDepth,this._samples);return"data:audio/wav;base64,"+encode(g.toBytes())};TR2099.prototype._fix8BitRange=function(){for(var a=0;a<this._samples.length;a++)this._samples[a]+=127};TR2099.prototype._fix32IEEERange=function(){for(var a=0;a<this._samples.length;a++)this._samples[a]/=2147483648};
TR2099.prototype._fix64BitRange=function(){for(var a=0;a<this._samples.length;a++)this._samples[a]/=0x7fffffffffffffff};TR2099.prototype._setAmplitude=function(a){a=a?parseInt(a):parseInt(this._bitDepth);this._amplitude=.7*BitDepths[a]};
TR2099.prototype._fixDecimated=function(a){var b;for(b=0;b<this._samples.length;b++)this._samples[b]=0<this._samples[b]?parseInt(this._samples[b])/this._amplitude:parseInt(this._samples[b])/(this._amplitude+1);this._amplitude=.7*BitDepths[parseInt(this._bitDepth)];this._sumSamples&&(this._amplitude/=a);this._gain()};
TR2099.prototype._getSamples=function(a){var b=0,d=0,e=[],c,f;for(c=0;c<a.length;c++){e[c]={samples:[],waveform:a[c].waveform,time:a[c].time};var g=Math.round(this._sampleRate*a[c].time);var h=g/this._sampleRate;for(f=0;f<g;f++){var k=f/g;k=this._waveform[a[c].waveform](h*k,k,d,a[c],b);e[c].samples.push(k)}d=2*Math.PI*h*(a[c].start+(a[c].end-a[c].start)/2);b+=d}return e};
TR2099.prototype._sequence=function(a){var b=[],d,e;for(d=0;d<a.length;d++)for(e=0;e<a[d].samples.length;e++)b.push(a[d].samples[e]);this._samples=b};
TR2099.prototype._sum=function(a){var b=0,d=0,e=!1,c=[],f;this._amplitude/=a.length;for(f=0;f<a.length;f++)a[f].time*this._sampleRate>b&&(b=a[f].time*this._sampleRate,d=f,0<f&&(e=!0));for(f=0;f<b;f++)c[f]=0;for(f=0;f<a.length;f++)for(b=0;b<a[f].samples.length;b++)e&&b>a[f].samples.length/1.1&&this._releaseOnSum(a,this._sampleRate,b,f,d),c[b]=parseFloat(a[f].samples[b])+parseFloat(c[b]);this._samples=c};
TR2099.prototype._releaseOnSum=function(a,b,d,e){var c=a[d].samples.length/this._sampleRate,f=.1*c,g=Math.round(this._sampleRate*c);c=g/this._sampleRate;g=b/g*c;d!=e&&(a[d].samples[b]/=f/(c-g)*f/(c-g))};TR2099.prototype._gain=function(){var a;for(a=0;a<this._samples.length;a++){var b=this._attackDecay(a);this._samples[a]=0<this._samples[a]?this._samples[a]*b:this._samples[a]*(b+1)}};
TR2099.prototype._attackDecay=function(a){var b=this._samples.length/this._sampleRate,d=(100-this._attack)/100*b,e=this._release/100*(b-d),c=Math.round(this._sampleRate*b);b=c/this._sampleRate;a=a/c*b;return a>d?a<b-e?this._amplitude:this._amplitude/(e/(b-a)*e/(b-a)):d?this._amplitude/(d/a*d/a):this._amplitude};